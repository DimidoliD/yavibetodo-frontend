<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ya Vibe Todo</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --surface: var(--tg-theme-secondary-bg-color, #f8f8f8);
    --hint: var(--tg-theme-hint-color, #eee);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: var(--tg-theme-bg-color, #0f1720);
      --text: var(--tg-theme-text-color, #e6eef6);
      --surface: var(--tg-theme-secondary-bg-color, #111827);
      --hint: var(--tg-theme-hint-color, #222);
    }
  }

  body{
    font-family: Arial, sans-serif;
    padding: 16px;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 80px;
  }

  .header{text-align:center;margin-bottom:20px}
  .header h1{font-size:24px;color:#2481cc;margin-bottom:8px}
  .tabs{display:flex;background:var(--hint);border-radius:10px;padding:4px;margin-bottom:20px}
  .tab{flex:1;padding:10px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:14px;color:var(--text)}
  .tab.active{background:#2481cc;color:#fff}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px}
  .stat-card{background:var(--surface);border-radius:10px;padding:16px;text-align:center;color:var(--text)}
  .stat-number{font-size:20px;font-weight:700;color:#2481cc;display:block}
  .stat-label{font-size:12px;color:var(--text);opacity:0.8;margin-top:4px}

  .todo-item{background:var(--surface);border-radius:10px;padding:16px;margin-bottom:12px;display:flex;align-items:flex-start;gap:12px;color:var(--text)}
  .todo-checkbox{width:20px;height:20px;border:2px solid rgba(0,0,0,0.12);border-radius:50%;cursor:pointer;position:relative;flex-shrink:0;margin-top:2px}
  .todo-checkbox.checked{background:#2481cc;border-color:#2481cc}
  .todo-checkbox.checked::after{content:'‚úì';position:absolute;color:white;font-size:12px;top:50%;left:50%;transform:translate(-50%,-50%)}
  .todo-content{flex:1}
  .todo-title{font-size:16px;margin-bottom:4px;color:var(--text)}
  .todo-meta{font-size:12px;color:var(--text);opacity:0.8}

  .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;margin-right:4px}
  .badge-high{background:rgba(214,47,47,0.12); color:#d63031}
  .badge-medium{background:rgba(225,145,85,0.12); color:#e17055}
  .badge-low{background:rgba(0,184,148,0.08); color:#00b894}
  .badge-deadline{background:rgba(9,132,227,0.08); color:#0984e3}
  .badge-overdue{background:rgba(214,47,47,0.08); color:#d63031}

  .todo-actions{display:flex;gap:8px}
  .todo-action{width:28px;height:28px;border:none;background:transparent;cursor:pointer;border-radius:4px;font-size:16px}

  .fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:#2481cc;border:none;color:white;font-size:28px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.2);z-index:1000}

  .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px}
  .modal.active{display:flex}
  .modal-content{background:var(--bg);color:var(--text);border-radius:10px;width:100%;max-width:420px}
  .modal-header{padding:20px;border-bottom:1px solid var(--hint);display:flex;justify-content:space-between;align-items:center}
  .modal-close{width:30px;height:30px;border:none;background:transparent;cursor:pointer;font-size:18px}
  .modal-body{padding:20px}

  .form-group{margin-bottom:16px}
  .form-label{display:block;margin-bottom:8px;font-weight:600;color:var(--text)}
  .form-input{width:100%;padding:12px;border:2px solid var(--hint);border-radius:8px;font-size:16px;background:var(--surface);color:var(--text)}
  .priority-options{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .priority-option{padding:10px;border:2px solid var(--hint);border-radius:6px;text-align:center;cursor:pointer;font-size:12px;color:var(--text)}
  .priority-option.selected{border-color:#2481cc;background:#2481cc;color:#fff}

  .btn{padding:12px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;margin-right:8px}
  .btn-primary{background:#2481cc;color:#fff}
  .btn-secondary{background:var(--hint);color:var(--text)}

  .empty-state{text-align:center;padding:40px 20px}
  .loading{text-align:center;padding:40px}

  .user-search{position:relative}
  .search-results{
    position:absolute;top:100%;left:0;right:0;background:var(--bg);color:var(--text);
    border:1px solid var(--hint);border-radius:6px;max-height:180px;overflow-y:auto;z-index:3000;display:none;
  }
  .search-result{padding:10px;cursor:pointer;border-bottom:1px solid var(--hint)}
  .search-result:hover{background:var(--surface)}
  .status-select{padding:6px;border-radius:6px;border:1px solid var(--hint);background:var(--surface);color:var(--text)}
</style>
</head>
<body>
  <div id="app"><div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

  <button class="fab" onclick="openModal()">+</button>

  <div class="modal" id="todoModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
          <input type="text" id="todoText" class="form-input" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
        </div>

        <div class="form-group">
          <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <div class="priority-options">
            <div class="priority-option" data-priority="high">üî• –í—ã—Å–æ–∫–∏–π</div>
            <div class="priority-option selected" data-priority="medium">‚ö° –°—Ä–µ–¥–Ω–∏–π</div>
            <div class="priority-option" data-priority="low">üå± –ù–∏–∑–∫–∏–π</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
          <input type="datetime-local" id="todoDeadline" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</label>
          <div class="delegation-hint">üí° –í–≤–µ–¥–∏—Ç–µ @username —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∑–∞–¥–∞—á—É –∫–æ–ª–ª–µ–≥–µ</div>
          <div class="user-search">
            <input type="text" id="assignToInput" class="form-input" placeholder="@username –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–µ–±—è" oninput="searchUsers(this.value)">
            <div class="search-results" id="searchResults"></div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <button class="btn btn-primary" id="createBtn" onclick="saveTodo()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
          <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  var app = {
    tg: null,
    user: null,
    todos: [],
    assignedTasks: [],
    delegatedTasks: [],
    currentTab: 'personal',
    apiUrl: 'https://yavibetodo-telegram-bot.onrender.com/api'
  };

  document.addEventListener('DOMContentLoaded', function(){
    if (window.Telegram && window.Telegram.WebApp) {
      app.tg = window.Telegram.WebApp;
      try{ if (typeof app.tg.ready === 'function') app.tg.ready(); } catch(e){}
      try{ if (typeof app.tg.expand === 'function') app.tg.expand(); } catch(e){}
    }
    loadUser();
  });

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–¥–∞—á
  async function loadUser(){
    try{
      var initData = (app.tg && app.tg.initData) ? app.tg.initData : '';
      var resp = await fetch(app.apiUrl + '/user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData: initData })
      });
      if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + resp.status);
      var data = await resp.json();
      app.user = data.user || { first_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', id: null };
      app.todos = data.todos || [];
      app.assignedTasks = data.assignedTasks || [];
      app.delegatedTasks = data.delegatedTasks || [];
      renderApp();
    } catch(e){
      console.error('loadUser error', e);
      document.getElementById('app').innerHTML = `
        <div class="empty-state">
          <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
          <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
          <button class="btn btn-primary" onclick="location.reload()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
      `;
    }
  }

  // --- –†–µ–Ω–¥–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ UI
  function renderApp(){
    var name = (app.user && app.user.first_name) ? app.user.first_name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('app').innerHTML = `
      <div class="header">
        <h1>üë• Ya Vibe Todo</h1>
        <p>–ü—Ä–∏–≤–µ—Ç, ${escapeHtml(name)}!</p>
      </div>
      <div class="tabs">
        <button class="tab ${app.currentTab==='personal'?'active':''}" onclick="switchTab('personal')">üìù –ú–æ–∏</button>
        <button class="tab ${app.currentTab==='assigned'?'active':''}" onclick="switchTab('assigned')">üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
        <button class="tab ${app.currentTab==='delegated'?'active':''}" onclick="switchTab('delegated')">üì§ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</button>
      </div>
      ${renderStats()}
      <div id="todosList">${renderCurrentTab()}</div>
    `;
    // –ü–æ—Å–ª–µ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è HTML –Ω–∞–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å—Ç–∞—Ç—É—Å—ã)
    attachDynamicHandlers();
  }

  function renderStats(){
    var stats = [], total, completed;
    if (app.currentTab === 'personal'){
      total = app.todos.length;
      completed = app.todos.filter(function(t){ return t.completed; }).length;
      stats = [
        {number: total, label: '–í—Å–µ–≥–æ'},
        {number: completed, label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'},
        {number: total - completed, label: '–í —Ä–∞–±–æ—Ç–µ'},
        {number: total > 0 ? Math.round((completed/total)*100) : 0, label: '%'}
      ];
    } else if (app.currentTab === 'assigned'){
      total = app.assignedTasks.length;
      completed = app.assignedTasks.filter(function(t){ return t.completed; }).length;
      var overdue = app.assignedTasks.filter(function(t){ return !t.completed && t.deadline && new Date(t.deadline) < new Date(); }).length;
      stats = [
        {number: total, label: '–ù–∞–∑–Ω–∞—á–µ–Ω–æ'},
        {number: completed, label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'},
        {number: total - completed, label: '–í —Ä–∞–±–æ—Ç–µ'},
        {number: overdue, label: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'}
      ];
    } else {
      total = app.delegatedTasks.length;
      completed = app.delegatedTasks.filter(function(t){ return t.completed; }).length;
      stats = [
        {number: total, label: '–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ'},
        {number: completed, label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'},
        {number: total - completed, label: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'},
        {number: total > 0 ? Math.round((completed/total)*100) : 0, label: '%'}
      ];
    }
    return '<div class="stats">' + stats.map(function(s){ return '<div class="stat-card"><span class="stat-number">' + s.number + '</span><div class="stat-label">' + s.label + '</div></div>'; }).join('') + '</div>';
  }

  function renderCurrentTab(){
    var tasks = [], emptyMessage = '';
    if (app.currentTab === 'personal'){ tasks = app.todos; emptyMessage = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ª–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á'; }
    else if (app.currentTab === 'assigned'){ tasks = app.assignedTasks; emptyMessage = '–í–∞–º –ø–æ–∫–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–ª–∏ –∑–∞–¥–∞—á'; }
    else { tasks = app.delegatedTasks; emptyMessage = '–í—ã –ø–æ–∫–∞ –Ω–∏–∫–æ–º—É –Ω–µ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–ª–∏ –∑–∞–¥–∞—á'; }

    if (!tasks || tasks.length === 0){
      return '<div class="empty-state"><h3>üìã ' + emptyMessage + '</h3><p>–ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</p></div>';
    }

    tasks = tasks.slice().sort(function(a,b){
      var ac = a.completed ? 1 : 0, bc = b.completed ? 1 : 0;
      if (ac !== bc) return ac - bc;
      return new Date(b.createdAt) - new Date(a.createdAt);
    });

    return tasks.map(function(t){ return renderTodoItem(t); }).join('');
  }

  function statusToLabel(st){
    if (!st) return '–í –æ—á–µ—Ä–µ–¥–∏';
    if (st === 'new') return '–í –æ—á–µ—Ä–µ–¥–∏';
    if (st === 'in_progress') return '–í —Ä–∞–±–æ—Ç–µ';
    if (st === 'done') return '–ì–æ—Ç–æ–≤–æ';
    return st;
  }

  // render –æ–¥–Ω–æ–≥–æ todo ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º select —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "assigned"
  function renderTodoItem(todo){
    var isOverdue = todo.deadline && new Date(todo.deadline) < new Date() && !todo.completed;
    var prLabel = (todo.priority === 'high') ? 'üî• –í–´–°–û–ö–ò–ô' : (todo.priority === 'medium') ? '‚ö° –°–†–ï–î–ù–ò–ô' : 'üå± –ù–ò–ó–ö–ò–ô';
    var assignedBadge = (todo.assignedTo && app.currentTab === 'delegated') ? '<span class="badge badge-deadline">üë§ ' + escapeHtml((todo.assignedTo && todo.assignedTo.first_name) || todo.assignedTo) + '</span>' : '';
    var assignedBy = (todo.assignedBy && app.currentTab === 'assigned') ? '<span class="badge badge-deadline">üë§ –û—Ç: ' + escapeHtml((todo.assignedBy && todo.assignedBy.first_name) || todo.assignedBy) + '</span>' : '';
    var deadlineHtml = todo.deadline ? '<span class="badge ' + (isOverdue ? 'badge-overdue' : 'badge-deadline') + '">' + (isOverdue ? '‚ö†Ô∏è –ü–†–û–°–†–û–ß–ï–ù–û' : 'üìÖ') + ' ' + escapeHtml(formatDate(todo.deadline)) + '</span>' : '';

    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç –±–µ–∫–µ–Ω–¥–∞)
    var status = todo.status || (todo.completed ? 'done' : 'new');

    // –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ assigned ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º select –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
    var statusControl = '';
    if (app.currentTab === 'assigned') {
      statusControl = `
        <div style="margin-top:8px;">
          <label style="font-size:12px;display:block;margin-bottom:6px;color:var(--text)">–°—Ç–∞—Ç—É—Å:</label>
          <select class="status-select" data-id="${escapeHtml(todo.id)}">
            <option value="new" ${status==='new'?'selected':''}>–í –æ—á–µ—Ä–µ–¥–∏</option>
            <option value="in_progress" ${status==='in_progress'?'selected':''}>–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done" ${status==='done'?'selected':''}>–ì–æ—Ç–æ–≤–æ</option>
          </select>
        </div>
      `;
    }

    return `
      <div class="todo-item ${isOverdue ? 'overdue' : ''}">
        <div class="todo-header" style="display:flex; width:100%">
          <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo(${JSON.stringify(todo.id)})"></div>
          <div class="todo-content">
            <div class="todo-title ${todo.completed ? 'completed' : ''}">${escapeHtml(todo.text)}</div>
            <div style="margin:8px 0;">
              <span class="badge badge-${todo.priority || 'medium'}">${prLabel}</span>
              ${deadlineHtml}
              ${assignedBadge}
              ${assignedBy}
            </div>
            <div class="todo-meta">–°–æ–∑–¥–∞–Ω–æ: ${escapeHtml(formatDate(todo.createdAt))} ${todo.completedAt ? ' ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ' + escapeHtml(formatDate(todo.completedAt)) : ''}</div>
            ${statusControl}
          </div>
          <div class="todo-actions" style="margin-left:12px">
            <button class="todo-action" onclick="deleteTodo(${JSON.stringify(todo.id)})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    `;
  }

  function switchTab(tab){
    app.currentTab = tab;
    renderApp();
  }

  // --- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á)
  function attachDynamicHandlers(){
    // –ø–æ–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ select'—ã —Å—Ç–∞—Ç—É—Å–æ–≤
    var selects = document.querySelectorAll('.status-select');
    Array.prototype.forEach.call(selects, function(sel){
      // remove previous listener guards
      sel.onchange = null;
      sel.addEventListener('change', function(){
        var id = sel.dataset.id;
        var newStatus = sel.value;
        changeStatus(id, newStatus);
      });
    });
  }

  async function changeStatus(id, newStatus){
    if (!id) return;
    // –ù–∞–π–¥—ë–º –∑–∞–¥–∞—á—É –≤ assignedTasks
    var todo = app.assignedTasks.find(function(t){ return t.id == id; });
    if (!todo) return;

    var prevStatus = todo.status || (todo.completed ? 'done' : 'new');
    // optimistic update UI
    todo.status = newStatus;
    if (newStatus === 'done') { todo.completed = true; todo.completedAt = new Date().toISOString(); }
    else { todo.completed = false; todo.completedAt = null; }
    renderApp();

    try {
      var resp = await fetch(app.apiUrl + '/todos/' + encodeURIComponent(id), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: app.user.id, status: newStatus })
      });
      if (!resp.ok) {
        throw new Error('–°—Ç–∞—Ç—É—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ' + resp.status);
      }
      // –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
      var updated = await resp.json().catch(()=>null);
      if (updated) {
        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–ª—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        Object.assign(todo, updated);
      }
      renderApp();
    } catch (e){
      console.error('changeStatus error', e);
      // –æ—Ç–∫–∞—Ç
      todo.status = prevStatus;
      if (prevStatus === 'done') { todo.completed = true; }
      else { todo.completed = false; todo.completedAt = null; }
      renderApp();
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
    }
  }

  // --- –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å completed (–≥–∞–ª–æ—á–∫–∞)
  async function toggleTodo(id){
    if (!id) return;
    var todo = null;
    if (app.currentTab === 'personal') todo = app.todos.find(function(t){ return t.id == id; });
    else if (app.currentTab === 'assigned') todo = app.assignedTasks.find(function(t){ return t.id == id; });
    else todo = app.delegatedTasks.find(function(t){ return t.id == id; });
    if (!todo) return;

    var newCompleted = !todo.completed;
    // optimistic
    todo.completed = newCompleted;
    if (newCompleted) todo.completedAt = new Date().toISOString();
    else todo.completedAt = null;
    renderApp();

    try {
      var resp = await fetch(app.apiUrl + '/todos/' + encodeURIComponent(id), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: app.user.id, completed: newCompleted })
      });
      if (!resp.ok) throw new Error('toggle error ' + resp.status);
      var updated = await resp.json().catch(()=>null);
      if (updated) Object.assign(todo, updated);
      renderApp();
    } catch (e){
      console.error('toggleTodo error', e);
      // –æ—Ç–∫–∞—Ç
      todo.completed = !newCompleted;
      if (!todo.completed) todo.completedAt = null;
      renderApp();
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.');
    }
  }

  // --- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: –ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞ —Å–ª—É—á–∞–π —Ä–∞–∑–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–æ–≤
  async function deleteTodo(id){
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
    if (!id) return;

    // –ù–∞–π–¥–µ–º –∏ –∑–∞–ø–æ–º–Ω–∏–º –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∑–∞–¥–∞—á–∞
    var listRef = (app.currentTab === 'personal') ? app.todos :
                  (app.currentTab === 'assigned') ? app.assignedTasks :
                  app.delegatedTasks;

    var idx = listRef.findIndex(function(t){ return t.id == id; });
    if (idx === -1){
      // –≤–æ–∑–º–æ–∂–Ω–æ –≤ –¥—Ä—É–≥–æ–º —Å–ø–∏—Å–∫–µ ‚Äî –∏—â–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª—è–µ–º —Ç–∞–º
      app.todos = app.todos.filter(function(t){ return t.id != id; });
      app.assignedTasks = app.assignedTasks.filter(function(t){ return t.id != id; });
      app.delegatedTasks = app.delegatedTasks.filter(function(t){ return t.id != id; });
      renderApp();
      return;
    }

    var removed = listRef.splice(idx,1)[0];
    renderApp();

    // helper: rollback
    function rollback(){
      listRef.splice(idx, 0, removed);
      renderApp();
    }

    // –ü–æ–ø—ã—Ç–∫–∞ 1: DELETE —Å userId –≤ query (—á–∞—Å—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
    try {
      var url1 = app.apiUrl + '/todos/' + encodeURIComponent(id) + '?userId=' + encodeURIComponent(app.user.id);
      var resp1 = await fetch(url1, { method: 'DELETE' });
      if (resp1.ok) {
        try{ if (app.tg && app.tg.HapticFeedback && typeof app.tg.HapticFeedback.notificationOccurred === 'function') app.tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
        return;
      }
    } catch(e){ console.warn('delete attempt1 failed', e); }

    // –ü–æ–ø—ã—Ç–∫–∞ 2: DELETE —Å body (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–µ—Ç JSON)
    try {
      var resp2 = await fetch(app.apiUrl + '/todos/' + encodeURIComponent(id), {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: app.user.id })
      });
      if (resp2.ok) {
        try{ if (app.tg && app.tg.HapticFeedback && typeof app.tg.HapticFeedback.notificationOccurred === 'function') app.tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
        return;
      }
    } catch(e){ console.warn('delete attempt2 failed', e); }

    // –ü–æ–ø—ã—Ç–∫–∞ 3: POST –Ω–∞ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç /delete (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—ç–∫–∏ —Ç–∞–∫ —Å–¥–µ–ª–∞–Ω—ã)
    try {
      var resp3 = await fetch(app.apiUrl + '/todos/' + encodeURIComponent(id) + '/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: app.user.id })
      });
      if (resp3.ok) {
        try{ if (app.tg && app.tg.HapticFeedback && typeof app.tg.HapticFeedback.notificationOccurred === 'function') app.tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
        return;
      }
    } catch(e){ console.warn('delete attempt3 failed', e); }

    // –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    rollback();
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∞–≤–∞.');
  }

  // --- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ä–µ–Ω–¥–µ—Ä–∏–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫). –û–∂–∏–¥–∞–µ—Ç—Å—è JSON –æ—Ç API [{username, first_name, last_name}]
  async function searchUsers(query){
    var resultsBox = document.getElementById('searchResults');
    if (!resultsBox) return;
    if (!query || query.trim().length === 0){ resultsBox.style.display = 'none'; return; }

    var q = query.trim();
    if (q.startsWith('@')) q = q.substring(1);
    if (q.length < 1) { resultsBox.style.display = 'none'; return; }

    try {
      var resp = await fetch(app.apiUrl + '/users/search?query=' + encodeURIComponent(q));
      if (!resp.ok) { resultsBox.style.display = 'none'; return; }
      var users = await resp.json();
      if (!users || users.length === 0){
        resultsBox.innerHTML = '<div class="search-result">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        resultsBox.style.display = 'block';
        return;
      }
      resultsBox.innerHTML = users.map(function(u){
        var uname = u.username || '';
        var disp = (u.first_name || '') + (u.last_name ? (' ' + u.last_name) : '');
        return '<div class="search-result" data-username="' + escapeHtml(uname) + '"><strong>@' + escapeHtml(uname) + '</strong><br><small>' + escapeHtml(disp) + '</small></div>';
      }).join('');
      // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ ‚Äî –Ω–∞–¥—ë–∂–Ω–µ–µ, —á–µ–º inline onclick
      Array.prototype.forEach.call(resultsBox.querySelectorAll('.search-result'), function(el){
        el.addEventListener('click', function(){
          var un = el.dataset.username || '';
          selectUser(un);
        });
      });
      resultsBox.style.display = 'block';
    } catch (e){
      console.error('searchUsers error', e);
      resultsBox.style.display = 'none';
    }
  }

  function selectUser(username){
    if (!username) return;
    var inpt = document.getElementById('assignToInput');
    var u = String(username);
    if (u.startsWith('@')) u = u.substring(1);
    if (inpt) inpt.value = '@' + u;
    var sr = document.getElementById('searchResults'); if (sr) sr.style.display = 'none';
  }

  // --- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
  async function saveTodo(){
    var textEl = document.getElementById('todoText'), text = textEl ? textEl.value.trim() : '';
    if (!text){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'); if (textEl) textEl.focus(); return; }
    var prEl = document.querySelector('.priority-option.selected'), priority = prEl ? prEl.dataset.priority : 'medium';
    var deadline = (document.getElementById('todoDeadline') && document.getElementById('todoDeadline').value) ? document.getElementById('todoDeadline').value : null;
    var assignVal = (document.getElementById('assignToInput') && document.getElementById('assignToInput').value) ? document.getElementById('assignToInput').value.trim() : '';
    var assignedTo = assignVal && assignVal.startsWith('@') ? assignVal.substring(1) : (assignVal || null);

    var submitBtn = document.getElementById('createBtn') || document.querySelector('.btn-primary');
    var originalText = submitBtn ? submitBtn.textContent : '';
    if (submitBtn){ submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...'; submitBtn.disabled = true; }

    try {
      var resp = await fetch(app.apiUrl + '/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: app.user.id, text: text, priority: priority, deadline: deadline, assignedTo: assignedTo })
      });
      if (resp.ok){
        var newTodo = await resp.json().catch(()=>null);
        if (assignedTo) { app.delegatedTasks.push(newTodo || { id: Date.now(), text, priority, deadline, assignedTo }); alert('‚úÖ –ó–∞–¥–∞—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @' + assignedTo + '!'); }
        else { app.todos.push(newTodo || { id: Date.now(), text, priority, deadline }); }
        closeModal();
        renderApp();
      } else {
        var err = {};
        try { err = await resp.json(); } catch(e){}
        alert('‚ùå –û—à–∏–±–∫–∞: ' + (err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É'));
      }
    } catch (e){
      console.error('saveTodo error', e);
      alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    } finally {
      if (submitBtn){ submitBtn.textContent = originalText; submitBtn.disabled = false; }
    }
  }

  function escapeHtml(text){
    if (text === null || text === undefined) return '';
    var d = document.createElement('div'); d.textContent = String(text); return d.innerHTML;
  }

  function formatDate(dateString){
    if (!dateString) return '';
    var d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    var now = new Date();
    var diffDays = Math.ceil((d - now) / (1000*60*60*24));
    if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 1) return '–ó–∞–≤—Ç—Ä–∞';
    if (diffDays === -1) return '–í—á–µ—Ä–∞';
    if (diffDays > 1 && diffDays <= 7) return '–ß–µ—Ä–µ–∑ ' + diffDays + ' –¥–Ω.';
    return d.toLocaleDateString('ru');
  }

  function openModal(){ var m = document.getElementById('todoModal'); if (m) m.classList.add('active'); setTimeout(function(){ var t=document.getElementById('todoText'); if (t) t.focus(); },120); }
  function closeModal(){
    var m = document.getElementById('todoModal'); if (m) m.classList.remove('active');
    var t = document.getElementById('todoText'); if (t) t.value = '';
    var d = document.getElementById('todoDeadline'); if (d) d.value = '';
    var a = document.getElementById('assignToInput'); if (a) a.value = '';
    var sr = document.getElementById('searchResults'); if (sr) sr.style.display = 'none';
    document.querySelectorAll('.priority-option').forEach(function(o){ o.classList.remove('selected'); if (o.dataset.priority === 'medium') o.classList.add('selected'); });
  }

  // –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞/–∫–ª–∞–≤–∏—à
  document.addEventListener('click', function(e){
    var pr = e.target.closest ? e.target.closest('.priority-option') : null;
    if (pr){ document.querySelectorAll('.priority-option').forEach(function(o){ o.classList.remove('selected'); }); pr.classList.add('selected'); }
    var modal = document.getElementById('todoModal'); if (modal && e.target === modal) closeModal();
    var searchContainer = document.querySelector('.user-search');
    if (searchContainer && !searchContainer.contains(e.target)){
      var sr = document.getElementById('searchResults'); if (sr) sr.style.display = 'none';
    }
  });
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeModal(); });

</script>
</body>
</html>
