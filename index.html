<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ya Vibe Todo</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Arial, sans-serif;
      padding:16px;
      background:var(--tg-theme-bg-color,#fff);
      color:var(--tg-theme-text-color,#000);
      padding-bottom:80px;
    }
    .header{text-align:center;margin-bottom:20px}
    .header h1{font-size:24px;color:#2481cc;margin-bottom:8px}
    .tabs{display:flex;background:#f0f0f0;border-radius:10px;padding:4px;margin-bottom:20px}
    .tab{flex:1;padding:10px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:14px}
    .tab.active{background:#2481cc;color:white}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px}
    .stat-card{background:#f8f8f8;border-radius:10px;padding:16px;text-align:center}
    .stat-number{font-size:20px;font-weight:bold;color:#2481cc;display:block}
    .stat-label{font-size:12px;color:#666;margin-top:4px}
    .todo-item{background:#f8f8f8;border-radius:10px;padding:16px;margin-bottom:12px;display:flex;align-items:flex-start;gap:12px}
    .todo-checkbox{width:20px;height:20px;border:2px solid #ccc;border-radius:50%;cursor:pointer;position:relative;flex-shrink:0;margin-top:2px}
    .todo-checkbox.checked{background:#2481cc;border-color:#2481cc}
    .todo-checkbox.checked::after{content:'‚úì';position:absolute;color:white;font-size:12px;top:50%;left:50%;transform:translate(-50%,-50%)}
    .todo-content{flex:1}
    .todo-title{font-size:16px;margin-bottom:4px}
    .todo-meta{font-size:12px;color:#666}
    .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;margin-right:4px}
    .badge-high{background:#ffe6e6;color:#d63031}
    .badge-medium{background:#fff3cd;color:#e17055}
    .badge-low{background:#d1f2eb;color:#00b894}
    .badge-deadline{background:#e3f2fd;color:#0984e3}
    .badge-overdue{background:#ffebee;color:#d63031}
    .todo-actions{display:flex;gap:8px}
    .todo-action{width:28px;height:28px;border:none;background:transparent;cursor:pointer;border-radius:4px}
    .fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:#2481cc;border:none;color:white;font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:1000}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px}
    .modal.active{display:flex}
    .modal-content{background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);border-radius:10px;width:100%;max-width:420px}
    .modal-header{padding:20px;border-bottom:1px solid var(--tg-theme-hint-color,#eee);display:flex;justify-content:space-between;align-items:center}
    .modal-close{width:30px;height:30px;border:none;background:transparent;cursor:pointer;font-size:18px}
    .modal-body{padding:20px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:8px;font-weight:500}
    .form-input{
      width:100%;padding:12px;border:2px solid var(--tg-theme-hint-color,#eee);border-radius:8px;font-size:16px;
      background:var(--tg-theme-secondary-bg-color,#fff);color:var(--tg-theme-text-color,#000)
    }
    .priority-options{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .priority-option{padding:10px;border:2px solid var(--tg-theme-hint-color,#eee);border-radius:6px;text-align:center;cursor:pointer;font-size:12px}
    .priority-option.selected{border-color:#2481cc;background:#2481cc;color:white}
    .btn{padding:12px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;margin-right:8px}
    .btn-primary{background:#2481cc;color:white}
    .btn-secondary{background:var(--tg-theme-secondary-bg-color,#eee);color:var(--tg-theme-text-color,#333)}
    .empty-state{text-align:center;padding:40px 20px}
    .loading{text-align:center;padding:40px}
    .user-search{position:relative}
    .search-results{
      position:absolute;top:100%;left:0;right:0;
      background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);
      border:1px solid var(--tg-theme-hint-color,#eee);
      border-radius:6px;max-height:180px;overflow-y:auto;z-index:3000;display:none;
    }
    .search-result{padding:10px;cursor:pointer;border-bottom:1px solid var(--tg-theme-hint-color,#f0f0f0)}
    .search-result:hover{background:var(--tg-theme-secondary-bg-color,#f8f8f8)}
    /* –Ω–µ–±–æ–ª—å—à–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç—ë–º–Ω—É—é —Ç–µ–º—É, –µ—Å–ª–∏ Telegram –Ω–µ –≤—ã—Å—Ç–∞–≤–∏–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
    @media (prefers-color-scheme: dark){
      :root{
        --tg-theme-bg-color:#111;
        --tg-theme-text-color:#e6e6e6;
        --tg-theme-secondary-bg-color:#1a1a1a;
        --tg-theme-hint-color:#2a2a2a;
      }
    }
  </style>
</head>
<body>
  <div id="app"><div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

  <button class="fab" onclick="openModal()">+</button>

  <!-- –º–æ–¥–∞–ª–∫–∞ (–æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä) -->
  <div class="modal" id="todoModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
          <input type="text" class="form-input" id="todoText" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
        </div>

        <div class="form-group">
          <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <div class="priority-options">
            <div class="priority-option" data-priority="high">üî• –í—ã—Å–æ–∫–∏–π</div>
            <div class="priority-option selected" data-priority="medium">‚ö° –°—Ä–µ–¥–Ω–∏–π</div>
            <div class="priority-option" data-priority="low">üå± –ù–∏–∑–∫–∏–π</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
          <input type="datetime-local" class="form-input" id="todoDeadline">
        </div>

        <div class="form-group">
          <label class="form-label">–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</label>
          <div class="delegation-hint">üí° –í–≤–µ–¥–∏—Ç–µ @username —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∑–∞–¥–∞—á—É –∫–æ–ª–ª–µ–≥–µ</div>
          <div class="user-search">
            <input type="text" class="form-input" id="assignToInput"
                   placeholder="@username –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–µ–±—è"
                   oninput="searchUsers(this.value)">
            <div class="search-results" id="searchResults"></div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:32px">
          <button class="btn btn-primary" id="createBtn" onclick="saveTodo()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
          <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ó–∞—â–∏—Ç–Ω—ã–π, –ø–æ–ª–Ω—ã–π JS ‚Äî –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å API, + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã
    var app = {
      tg: null,
      user: null,
      todos: [],
      assignedTasks: [],
      delegatedTasks: [],
      currentTab: 'personal',
      apiUrl: 'https://yavibetodo-telegram-bot.onrender.com/api'
    };

    document.addEventListener('DOMContentLoaded', function(){
      if (window.Telegram && window.Telegram.WebApp) {
        app.tg = window.Telegram.WebApp;
        try { if (typeof app.tg.ready === 'function') app.tg.ready(); } catch(e){}
        try { if (typeof app.tg.expand === 'function') app.tg.expand(); } catch(e){}
      }
      loadUser();
    });

    async function loadUser(){
      try {
        var initData = (app.tg && app.tg.initData) ? app.tg.initData : '';
        var resp = await fetch(app.apiUrl + '/user', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ initData: initData })
        });
        if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + resp.status);
        var data = await resp.json();
        app.user = data.user || { first_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', id: null };
        app.todos = data.todos || [];
        app.assignedTasks = data.assignedTasks || [];
        app.delegatedTasks = data.delegatedTasks || [];
        renderApp();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ loadUser:', err);
        document.getElementById('app').innerHTML = `
          <div class="empty-state">
            <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
            <button class="btn btn-primary" onclick="location.reload()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          </div>
        `;
      }
    }

    function renderApp(){
      var name = (app.user && app.user.first_name) ? app.user.first_name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>üë• Ya Vibe Todo</h1>
          <p>–ü—Ä–∏–≤–µ—Ç, ${escapeHtml(name)}!</p>
        </div>
        <div class="tabs">
          <button class="tab ${app.currentTab==='personal'?'active':''}" onclick="switchTab('personal')">üìù –ú–æ–∏</button>
          <button class="tab ${app.currentTab==='assigned'?'active':''}" onclick="switchTab('assigned')">üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
          <button class="tab ${app.currentTab==='delegated'?'active':''}" onclick="switchTab('delegated')">üì§ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</button>
        </div>
        ${renderStats()}
        <div id="todosList">${renderCurrentTab()}</div>
      `;
    }

    function renderStats(){
      var stats=[], total, completed;
      if (app.currentTab==='personal'){
        total = app.todos.length;
        completed = app.todos.filter(function(t){return t.completed}).length;
        stats = [{number:total,label:'–í—Å–µ–≥–æ'},{number:completed,label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ'},{number:total-completed,label:'–í —Ä–∞–±–æ—Ç–µ'},{number: total>0?Math.round((completed/total)*100):0,label:'%'}];
      } else if (app.currentTab==='assigned'){
        total = app.assignedTasks.length;
        completed = app.assignedTasks.filter(function(t){return t.completed}).length;
        var overdue = app.assignedTasks.filter(function(t){return !t.completed && t.deadline && new Date(t.deadline) < new Date()}).length;
        stats = [{number:total,label:'–ù–∞–∑–Ω–∞—á–µ–Ω–æ'},{number:completed,label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ'},{number:total-completed,label:'–í —Ä–∞–±–æ—Ç–µ'},{number:overdue,label:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'}];
      } else {
        total = app.delegatedTasks.length;
        completed = app.delegatedTasks.filter(function(t){return t.completed}).length;
        stats = [{number:total,label:'–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ'},{number:completed,label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ'},{number:total-completed,label:'–í –ø—Ä–æ—Ü–µ—Å—Å–µ'},{number: total>0?Math.round((completed/total)*100):0,label:'%'}];
      }
      return '<div class="stats">'+stats.map(function(s){return '<div class="stat-card"><span class="stat-number">'+s.number+'</span><div class="stat-label">'+s.label+'</div></div>'}).join('')+'</div>';
    }

    function renderCurrentTab(){
      var tasks=[], emptyMessage='';
      if (app.currentTab==='personal'){ tasks = app.todos; emptyMessage = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ª–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á'; }
      else if (app.currentTab==='assigned'){ tasks = app.assignedTasks; emptyMessage = '–í–∞–º –ø–æ–∫–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–ª–∏ –∑–∞–¥–∞—á'; }
      else { tasks = app.delegatedTasks; emptyMessage = '–í—ã –ø–æ–∫–∞ –Ω–∏–∫–æ–º—É –Ω–µ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–ª–∏ –∑–∞–¥–∞—á'; }

      if (!tasks || tasks.length===0) return '<div class="empty-state"><h3>üìã '+emptyMessage+'</h3><p>–ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</p></div>';

      tasks = tasks.slice().sort(function(a,b){
        var ac = a.completed?1:0, bc = b.completed?1:0;
        if (ac!==bc) return ac-bc;
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      return tasks.map(function(t){ return renderTodoItem(t); }).join('');
    }

    function renderTodoItem(todo){
      var isOverdue = todo.deadline && new Date(todo.deadline) < new Date() && !todo.completed;
      var prLabel = (todo.priority==='high')?'üî• –í–´–°–û–ö–ò–ô':(todo.priority==='medium'?'‚ö° –°–†–ï–î–ù–ò–ô':'üå± –ù–ò–ó–ö–ò–ô');
      var assignedBadge = (todo.assignedTo && app.currentTab==='delegated')?'<span class="badge badge-deadline">üë§ '+escapeHtml((todo.assignedTo && todo.assignedTo.first_name) || todo.assignedTo)+'</span>':'';
      var assignedBy = (todo.assignedBy && app.currentTab==='assigned')?'<span class="badge badge-deadline">üë§ –û—Ç: '+escapeHtml((todo.assignedBy && todo.assignedBy.first_name) || todo.assignedBy)+'</span>':'';
      var deadlineHtml = todo.deadline?'<span class="badge '+(isOverdue?'badge-overdue':'badge-deadline')+'">'+(isOverdue?'‚ö†Ô∏è –ü–†–û–°–†–û–ß–ï–ù–û':'üìÖ')+' '+escapeHtml(formatDate(todo.deadline))+'</span>':'';
      return '<div class="todo-item '+(isOverdue?'overdue':'')+'">'+
                '<div class="todo-header">'+
                  '<div class="todo-checkbox '+(todo.completed?'checked':'')+'" onclick="toggleTodo('+JSON.stringify(todo.id)+')"></div>'+
                  '<div class="todo-content">'+
                    '<div class="todo-title '+(todo.completed?'completed':'')+'">'+escapeHtml(todo.text)+'</div>'+
                    '<div style="margin:8px 0;">'+
                      '<span class="badge badge-'+(todo.priority||'medium')+'">'+prLabel+'</span>'+
                      deadlineHtml + assignedBadge + assignedBy +
                    '</div>'+
                    '<div class="todo-meta">–°–æ–∑–¥–∞–Ω–æ: '+escapeHtml(formatDate(todo.createdAt))+(todo.completedAt?(' ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: '+escapeHtml(formatDate(todo.completedAt))):'')+'</div>'+
                  '</div>'+
                  '<div class="todo-actions">'+
                    '<button class="todo-action" onclick="deleteTodo('+JSON.stringify(todo.id)+')" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">üóëÔ∏è</button>'+
                  '</div>'+
                '</div>'+
             '</div>';
    }

    function switchTab(tab){ app.currentTab = tab; renderApp(); }

    async function toggleTodo(id){
      var todo = null;
      if (app.currentTab==='personal') todo = app.todos.find(function(t){return t.id===id});
      else if (app.currentTab==='assigned') todo = app.assignedTasks.find(function(t){return t.id===id});
      else todo = app.delegatedTasks.find(function(t){return t.id===id});
      if (!todo) return;
      try {
        var resp = await fetch(app.apiUrl + '/todos/' + encodeURIComponent(id), {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId: app.user.id, completed: !todo.completed })
        });
        if (resp.ok){
          todo.completed = !todo.completed;
          if (todo.completed) todo.completedAt = new Date().toISOString();
          renderApp();
          try{ if (app.tg && app.tg.HapticFeedback && typeof app.tg.HapticFeedback.impactOccurred==='function') app.tg.HapticFeedback.impactOccurred('light'); }catch(e){}
        } else console.error('toggleTodo error', resp.status);
      } catch(e){ console.error('toggleTodo catch', e); }
    }

    async function deleteTodo(id){
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
      try {
        var resp = await fetch(app.apiUrl + '/todos/' + encodeURIComponent(id), {
          method:'DELETE', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId: app.user.id })
        });
        if (resp.ok){
          if (app.currentTab==='personal') app.todos = app.todos.filter(function(t){return t.id!==id});
          else if (app.currentTab==='assigned') app.assignedTasks = app.assignedTasks.filter(function(t){return t.id!==id});
          else app.delegatedTasks = app.delegatedTasks.filter(function(t){return t.id!==id});
          renderApp();
          try{ if (app.tg && app.tg.HapticFeedback && typeof app.tg.HapticFeedback.notificationOccurred==='function') app.tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
        } else console.error('deleteTodo error', resp.status);
      } catch(e){ console.error('deleteTodo catch', e); }
    }

    function openModal(){
      var modal = document.getElementById('todoModal'); if (modal) modal.classList.add('active');
      setTimeout(function(){ var t = document.getElementById('todoText'); if (t) t.focus(); }, 120);
    }
    function closeModal(){
      var modal = document.getElementById('todoModal'); if (modal) modal.classList.remove('active');
      var t = document.getElementById('todoText'); if (t) t.value='';
      var d = document.getElementById('todoDeadline'); if (d) d.value='';
      var a = document.getElementById('assignToInput'); if (a) a.value='';
      var sr = document.getElementById('searchResults'); if (sr) sr.style.display='none';
      document.querySelectorAll('.priority-option').forEach(function(o){ o.classList.remove('selected'); if (o.dataset.priority==='medium') o.classList.add('selected'); });
    }

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: strip '@' –µ—Å–ª–∏ –µ—Å—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API, —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    async function searchUsers(query){
      var resultsBox = document.getElementById('searchResults');
      if (!resultsBox) return;
      if (!query || query.trim().length===0){
        resultsBox.style.display = 'none';
        return;
      }
      var q = query.trim();
      if (q.startsWith('@')) q = q.substring(1);
      if (q.length < 1){
        resultsBox.style.display = 'none';
        return;
      }

      try {
        var resp = await fetch(app.apiUrl + '/users/search?query=' + encodeURIComponent(q));
        if (!resp.ok) { resultsBox.style.display = 'none'; return; }
        var users = await resp.json();
        if (!users || users.length===0){
          resultsBox.innerHTML = '<div class="search-result">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          resultsBox.style.display = 'block';
          return;
        }

        // —Ä–µ–Ω–¥–µ—Ä–∏–º –∏ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ JS (–Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º inline onclick)
        resultsBox.innerHTML = users.map(function(u){
          var username = u.username || '';
          var displayName = (u.first_name || '') + (u.last_name ? (' ' + u.last_name) : '');
          return '<div class="search-result" data-username="'+escapeHtml(username)+'"><strong>@'+escapeHtml(username)+'</strong><br><small>'+escapeHtml(displayName)+'</small></div>';
        }).join('');
        // –Ω–∞–≤–µ—Å–∏–º –∫–ª–∏–∫–∏
        Array.prototype.slice.call(resultsBox.querySelectorAll('.search-result')).forEach(function(el){
          el.addEventListener('click', function(){
            var un = el.dataset.username || '';
            selectUser(un);
          });
        });
        resultsBox.style.display = 'block';
      } catch(e){
        console.error('searchUsers error', e);
        resultsBox.style.display = 'none';
      }
    }

    function selectUser(username){
      if (!username) return;
      var inpt = document.getElementById('assignToInput');
      username = String(username);
      if (username.startsWith('@')) username = username.substring(1);
      if (inpt) inpt.value = '@' + username;
      var sr = document.getElementById('searchResults'); if (sr) sr.style.display = 'none';
    }

    async function saveTodo(){
      var textEl = document.getElementById('todoText'), text = textEl?textEl.value.trim():'';
      if (!text){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'); if (textEl) textEl.focus(); return; }
      var prEl = document.querySelector('.priority-option.selected'), priority = prEl?prEl.dataset.priority:'medium';
      var deadline = (document.getElementById('todoDeadline') && document.getElementById('todoDeadline').value) ? document.getElementById('todoDeadline').value : null;
      var assignVal = (document.getElementById('assignToInput') && document.getElementById('assignToInput').value) ? document.getElementById('assignToInput').value.trim() : '';
      var assignedTo = assignVal && assignVal.startsWith('@') ? assignVal.substring(1) : (assignVal || null);

      var submitBtn = document.getElementById('createBtn') || document.querySelector('.btn-primary');
      var originalText = submitBtn ? submitBtn.textContent : '';
      if (submitBtn){ submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...'; submitBtn.disabled = true; }

      try {
        var resp = await fetch(app.apiUrl + '/todos', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId: app.user.id, text: text, priority: priority, deadline: deadline, assignedTo: assignedTo })
        });
        if (resp.ok){
          var newTodo = await resp.json();
          if (assignedTo) { app.delegatedTasks.push(newTodo); alert('‚úÖ –ó–∞–¥–∞—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @'+assignedTo+'!\n–û–Ω–∏ –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.'); }
          else { app.todos.push(newTodo); }
          closeModal();
          renderApp();
          try{ if (app.tg && app.tg.HapticFeedback && typeof app.tg.HapticFeedback.notificationOccurred==='function') app.tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
        } else {
          var err = {};
          try { err = await resp.json(); } catch(e){}
          alert('‚ùå –û—à–∏–±–∫–∞: ' + (err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É'));
        }
      } catch(e){
        console.error('saveTodo error', e);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
      } finally {
        if (submitBtn){ submitBtn.textContent = originalText; submitBtn.disabled = false; }
      }
    }

    function escapeHtml(str){
      if (str===null || str===undefined) return '';
      var d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    function formatDate(dateString){
      if (!dateString) return '';
      var d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      var now = new Date();
      var diffDays = Math.ceil((d - now)/(1000*60*60*24));
      if (diffDays===0) return '–°–µ–≥–æ–¥–Ω—è';
      if (diffDays===1) return '–ó–∞–≤—Ç—Ä–∞';
      if (diffDays===-1) return '–í—á–µ—Ä–∞';
      if (diffDays>1 && diffDays<=7) return '–ß–µ—Ä–µ–∑ ' + diffDays + ' –¥–Ω.';
      return d.toLocaleDateString('ru');
    }

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞/escape
    document.addEventListener('click', function(e){
      var pr = e.target.closest ? e.target.closest('.priority-option') : null;
      if (pr){ document.querySelectorAll('.priority-option').forEach(function(o){ o.classList.remove('selected'); }); pr.classList.add('selected'); }
      var modal = document.getElementById('todoModal'); if (modal && e.target === modal) closeModal();
      var searchContainer = document.querySelector('.user-search');
      if (searchContainer && !searchContainer.contains(e.target)){
        var sr = document.getElementById('searchResults'); if (sr) sr.style.display = 'none';
      }
    });
    document.addEventListener('keydown', function(e){ if (e.key==='Escape') closeModal(); });

  </script>
</body>
</html>
